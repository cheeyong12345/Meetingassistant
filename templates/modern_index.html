{% extends "base.html" %}

{% block title %}Dashboard - Meeting Assistant{% endblock %}

{% block content %}
<!-- Hero Section with Quick Start -->
<div class="grid" style="grid-template-columns: 380px 1fr; gap: var(--spacing-xl); margin-bottom: var(--spacing-xl);">
    <!-- Left Column: Meeting Controls -->
    <div style="display: flex; flex-direction: column; gap: var(--spacing-lg);">
        <!-- Quick Start Card -->
        <div class="card card-sticky">
            <div class="card-header" style="background: linear-gradient(135deg, var(--color-primary) 0%, var(--color-primary-dark) 100%); border: none;">
                <h3 class="card-title" style="color: white; margin: 0;">
                    <svg width="24" height="24" viewBox="0 0 24 24" fill="currentColor" aria-hidden="true">
                        <path d="M12 2C6.48 2 2 6.48 2 12s4.48 10 10 10 10-4.48 10-10S17.52 2 12 2zm0 18c-4.41 0-8-3.59-8-8s3.59-8 8-8 8 3.59 8 8-3.59 8-8 8zm-1-13h2v6h-2zm0 8h2v2h-2z"/>
                    </svg>
                    Meeting Control
                </h3>
            </div>

            <div class="card-body">
                <!-- Status Display -->
                <div id="meeting-status" class="mb-3" role="status" aria-live="polite">
                    <div class="alert alert-info">
                        <div class="alert-icon">â„¹</div>
                        <div class="alert-content">
                            <strong>Ready to start</strong><br>
                            <small>No active meeting</small>
                        </div>
                    </div>
                </div>

                <!-- Start Meeting Form -->
                <div id="start-meeting-form">
                    <form id="meeting-form" aria-label="Start new meeting">
                        <div class="form-group">
                            <label for="meeting-title" class="form-label">
                                Meeting Title
                                <span style="color: var(--color-danger);" aria-label="required">*</span>
                            </label>
                            <input
                                type="text"
                                class="form-input"
                                id="meeting-title"
                                name="title"
                                placeholder="e.g., Team Standup, Client Review"
                                required
                                aria-required="true"
                            >
                            <small class="form-help">Give your meeting a descriptive title</small>
                        </div>

                        <div class="form-group">
                            <label for="participants" class="form-label">
                                Participants
                            </label>
                            <input
                                type="text"
                                class="form-input"
                                id="participants"
                                name="participants"
                                placeholder="John, Sarah, Mike"
                                aria-describedby="participants-help"
                            >
                            <small class="form-help" id="participants-help">Comma-separated names (optional)</small>
                        </div>

                        <button type="submit" class="btn btn-primary btn-lg btn-block" aria-label="Start meeting">
                            <svg width="20" height="20" viewBox="0 0 20 20" fill="currentColor" aria-hidden="true">
                                <path fill-rule="evenodd" d="M10 18a8 8 0 100-16 8 8 0 000 16zM9.555 7.168A1 1 0 008 8v4a1 1 0 001.555.832l3-2a1 1 0 000-1.664l-3-2z" clip-rule="evenodd"/>
                            </svg>
                            Start Meeting
                        </button>
                    </form>
                </div>

                <!-- Stop Meeting Button (Hidden by default) -->
                <div id="stop-meeting-form" style="display: none;">
                    <button id="stop-meeting-btn" class="btn btn-danger btn-lg btn-block" aria-label="Stop meeting">
                        <svg width="20" height="20" viewBox="0 0 20 20" fill="currentColor" aria-hidden="true">
                            <path fill-rule="evenodd" d="M10 18a8 8 0 100-16 8 8 0 000 16zM8 7a1 1 0 00-1 1v4a1 1 0 001 1h4a1 1 0 001-1V8a1 1 0 00-1-1H8z" clip-rule="evenodd"/>
                        </svg>
                        Stop Meeting
                    </button>

                    <!-- Waveform Visualization -->
                    <div id="waveform-container" class="waveform-container" style="display: none; margin-top: var(--spacing-md);" aria-hidden="true">
                        <!-- Bars added dynamically by JS -->
                    </div>
                </div>
            </div>
        </div>

        <!-- Engine Status Card -->
        <div class="card">
            <div class="card-header">
                <h5 class="card-title" style="margin: 0;">
                    <svg width="20" height="20" viewBox="0 0 20 20" fill="currentColor" aria-hidden="true">
                        <path fill-rule="evenodd" d="M6.672 1.911a1 1 0 10-1.932.518l.259.966a1 1 0 001.932-.518l-.26-.966zM2.429 4.74a1 1 0 10-.517 1.932l.966.259a1 1 0 00.517-1.932l-.966-.26zm8.814-.569a1 1 0 00-1.415-1.414l-.707.707a1 1 0 101.415 1.415l.707-.708zm-7.071 7.072l.707-.707A1 1 0 003.465 9.12l-.708.707a1 1 0 001.415 1.415zm3.2-5.171a1 1 0 00-1.3 1.3l4 10a1 1 0 001.823.075l1.38-2.759 3.018 3.02a1 1 0 001.414-1.415l-3.019-3.02 2.76-1.379a1 1 0 00-.076-1.822l-10-4z" clip-rule="evenodd"/>
                    </svg>
                    Engine Status
                </h5>
            </div>
            <div class="card-body">
                <div class="mb-3">
                    <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: var(--spacing-xs);">
                        <strong style="font-size: var(--font-size-sm);">Speech-to-Text:</strong>
                        <span id="stt-engine" class="badge badge-secondary">Not initialized</span>
                    </div>
                    <div style="height: 4px; background: var(--color-gray-200); border-radius: var(--radius-full); overflow: hidden;">
                        <div id="stt-progress" style="height: 100%; width: 0%; background: var(--color-success); transition: width 0.3s;"></div>
                    </div>
                </div>

                <div class="mb-3">
                    <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: var(--spacing-xs);">
                        <strong style="font-size: var(--font-size-sm);">Summarization:</strong>
                        <span id="sum-engine" class="badge badge-secondary">Not initialized</span>
                    </div>
                    <div style="height: 4px; background: var(--color-gray-200); border-radius: var(--radius-full); overflow: hidden;">
                        <div id="sum-progress" style="height: 100%; width: 0%; background: var(--color-success); transition: width 0.3s;"></div>
                    </div>
                </div>

                <button id="refresh-status" class="btn btn-outline btn-block" aria-label="Refresh engine status">
                    <svg width="16" height="16" viewBox="0 0 20 20" fill="currentColor" aria-hidden="true">
                        <path fill-rule="evenodd" d="M4 2a1 1 0 011 1v2.101a7.002 7.002 0 0111.601 2.566 1 1 0 11-1.885.666A5.002 5.002 0 005.999 7H9a1 1 0 010 2H4a1 1 0 01-1-1V3a1 1 0 011-1zm.008 9.057a1 1 0 011.276.61A5.002 5.002 0 0014.001 13H11a1 1 0 110-2h5a1 1 0 011 1v5a1 1 0 11-2 0v-2.101a7.002 7.002 0 01-11.601-2.566 1 1 0 01.61-1.276z" clip-rule="evenodd"/>
                    </svg>
                    Refresh Status
                </button>
            </div>
        </div>

        <!-- Live Metrics (Hidden when not recording) -->
        <div id="live-metrics" class="card" style="display: none;">
            <div class="card-header">
                <h5 class="card-title" style="margin: 0;">
                    <svg width="20" height="20" viewBox="0 0 20 20" fill="currentColor" aria-hidden="true">
                        <path d="M2 11a1 1 0 011-1h2a1 1 0 011 1v5a1 1 0 01-1 1H3a1 1 0 01-1-1v-5zM8 7a1 1 0 011-1h2a1 1 0 011 1v9a1 1 0 01-1 1H9a1 1 0 01-1-1V7zM14 4a1 1 0 011-1h2a1 1 0 011 1v12a1 1 0 01-1 1h-2a1 1 0 01-1-1V4z"/>
                    </svg>
                    Live Metrics
                </h5>
            </div>
            <div class="card-body">
                <div class="metric-card" style="border: none; padding: var(--spacing-md) 0;">
                    <div class="metric-label">Duration</div>
                    <div class="metric-value" id="meeting-duration" style="font-size: var(--font-size-2xl);">00:00</div>
                </div>
                <div class="metric-card" style="border: none; padding: var(--spacing-md) 0;">
                    <div class="metric-label">Word Count</div>
                    <div class="metric-value" id="word-count" style="font-size: var(--font-size-2xl);">0</div>
                </div>
            </div>
        </div>
    </div>

    <!-- Right Column: Live Transcript & Summary -->
    <div style="display: flex; flex-direction: column; gap: var(--spacing-xl);">
        <!-- Live Transcript Card -->
        <div class="card">
            <div class="card-header" style="display: flex; justify-content: space-between; align-items: center;">
                <h4 class="card-title" style="margin: 0;">
                    <svg width="24" height="24" viewBox="0 0 24 24" fill="currentColor" aria-hidden="true">
                        <path d="M9 2a1 1 0 000 2h2a1 1 0 100-2H9z"/>
                        <path fill-rule="evenodd" d="M4 5a2 2 0 012-2 3 3 0 003 3h2a3 3 0 003-3 2 2 0 012 2v11a2 2 0 01-2 2H6a2 2 0 01-2-2V5zm3 4a1 1 0 000 2h.01a1 1 0 100-2H7zm3 0a1 1 0 000 2h3a1 1 0 100-2h-3zm-3 4a1 1 0 000 2h.01a1 1 0 100-2H7zm3 0a1 1 0 000 2h3a1 1 0 100-2h-3z" clip-rule="evenodd"/>
                    </svg>
                    Live Transcript
                </h4>

                <div id="recording-indicator" class="recording-indicator" style="display: none;" role="status" aria-live="assertive">
                    <span class="recording-indicator-dot" aria-hidden="true"></span>
                    <span>REC</span>
                </div>
            </div>

            <div class="card-body">
                <!-- Transcript Container -->
                <div id="transcript" class="transcript-container" role="log" aria-live="polite" aria-atomic="false">
                    <div class="transcript-empty">
                        <div class="transcript-empty-icon">ðŸŽ¤</div>
                        <div>Start a meeting to see the live transcript here...</div>
                        <small style="color: var(--color-gray-500);">Real-time speech-to-text will appear as you speak</small>
                    </div>
                </div>

                <!-- Transcript Actions -->
                <div style="display: flex; justify-content: space-between; align-items: center; margin-top: var(--spacing-md); padding-top: var(--spacing-md); border-top: 1px solid var(--color-gray-200);">
                    <div style="font-size: var(--font-size-sm); color: var(--color-gray-600);">
                        <span id="transcript-stats">Ready to record</span>
                    </div>
                    <div style="display: flex; gap: var(--spacing-sm);">
                        <button id="copy-transcript" class="btn btn-ghost btn-sm" disabled aria-label="Copy transcript">
                            <svg width="16" height="16" viewBox="0 0 20 20" fill="currentColor" aria-hidden="true">
                                <path d="M8 3a1 1 0 011-1h2a1 1 0 110 2H9a1 1 0 01-1-1z"/>
                                <path d="M6 3a2 2 0 00-2 2v11a2 2 0 002 2h8a2 2 0 002-2V5a2 2 0 00-2-2 3 3 0 01-3 3H9a3 3 0 01-3-3z"/>
                            </svg>
                            Copy
                        </button>
                        <button id="download-transcript" class="btn btn-ghost btn-sm" disabled aria-label="Download transcript">
                            <svg width="16" height="16" viewBox="0 0 20 20" fill="currentColor" aria-hidden="true">
                                <path fill-rule="evenodd" d="M3 17a1 1 0 011-1h12a1 1 0 110 2H4a1 1 0 01-1-1zm3.293-7.707a1 1 0 011.414 0L9 10.586V3a1 1 0 112 0v7.586l1.293-1.293a1 1 0 111.414 1.414l-3 3a1 1 0 01-1.414 0l-3-3a1 1 0 010-1.414z" clip-rule="evenodd"/>
                            </svg>
                            Download
                        </button>
                    </div>
                </div>
            </div>
        </div>

        <!-- Meeting Summary (Hidden until meeting ends) -->
        <div id="meeting-summary" class="card" style="display: none;">
            <div class="card-header" style="background: linear-gradient(135deg, var(--color-secondary) 0%, var(--color-primary) 100%); border: none;">
                <h4 class="card-title" style="color: white; margin: 0;">
                    <svg width="24" height="24" viewBox="0 0 24 24" fill="currentColor" aria-hidden="true">
                        <path fill-rule="evenodd" d="M6 2a2 2 0 00-2 2v12a2 2 0 002 2h8a2 2 0 002-2V7.414A2 2 0 0015.414 6L12 2.586A2 2 0 0010.586 2H6zm5 6a1 1 0 10-2 0v3.586l-1.293-1.293a1 1 0 10-1.414 1.414l3 3a1 1 0 001.414 0l3-3a1 1 0 00-1.414-1.414L11 11.586V8z" clip-rule="evenodd"/>
                    </svg>
                    Meeting Summary
                </h4>
            </div>

            <div class="card-body">
                <div id="summary-content">
                    <!-- Summary will be populated here by JS -->
                </div>

                <!-- Summary Actions -->
                <div style="display: flex; gap: var(--spacing-sm); margin-top: var(--spacing-lg); padding-top: var(--spacing-lg); border-top: 1px solid var(--color-gray-200);">
                    <button id="copy-summary" class="btn btn-outline" aria-label="Copy summary">
                        <svg width="16" height="16" viewBox="0 0 20 20" fill="currentColor" aria-hidden="true">
                            <path d="M8 3a1 1 0 011-1h2a1 1 0 110 2H9a1 1 0 01-1-1z"/>
                            <path d="M6 3a2 2 0 00-2 2v11a2 2 0 002 2h8a2 2 0 002-2V5a2 2 0 00-2-2 3 3 0 01-3 3H9a3 3 0 01-3-3z"/>
                        </svg>
                        Copy
                    </button>
                    <button id="download-summary" class="btn btn-outline" aria-label="Download summary">
                        <svg width="16" height="16" viewBox="0 0 20 20" fill="currentColor" aria-hidden="true">
                            <path fill-rule="evenodd" d="M3 17a1 1 0 011-1h12a1 1 0 110 2H4a1 1 0 01-1-1zm3.293-7.707a1 1 0 011.414 0L9 10.586V3a1 1 0 112 0v7.586l1.293-1.293a1 1 0 111.414 1.414l-3 3a1 1 0 01-1.414 0l-3-3a1 1 0 010-1.414z" clip-rule="evenodd"/>
                        </svg>
                        Download
                    </button>
                    <button id="share-summary" class="btn btn-primary" aria-label="Share summary">
                        <svg width="16" height="16" viewBox="0 0 20 20" fill="currentColor" aria-hidden="true">
                            <path d="M15 8a3 3 0 10-2.977-2.63l-4.94 2.47a3 3 0 100 4.319l4.94 2.47a3 3 0 10.895-1.789l-4.94-2.47a3.027 3.027 0 000-.74l4.94-2.47C13.456 7.68 14.19 8 15 8z"/>
                        </svg>
                        Share
                    </button>
                </div>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block extra_js %}
<script>
// Page-specific initialization
document.addEventListener('DOMContentLoaded', function() {
    console.log('[Dashboard] Page loaded');

    // Start meeting form submission
    const meetingForm = document.getElementById('meeting-form');
    if (meetingForm) {
        meetingForm.addEventListener('submit', async function(e) {
            e.preventDefault();

            const title = document.getElementById('meeting-title').value.trim();
            const participants = document.getElementById('participants').value.trim();

            if (!title) {
                NotificationManager.show('Please enter a meeting title', 'warning');
                document.getElementById('meeting-title').focus();
                return;
            }

            await MeetingManager.startMeeting(title, participants);
        });
    }

    // Stop meeting button
    const stopBtn = document.getElementById('stop-meeting-btn');
    if (stopBtn) {
        stopBtn.addEventListener('click', async function() {
            const confirmed = confirm('Are you sure you want to stop the meeting?\n\nThe transcript will be saved and a summary will be generated.');

            if (confirmed) {
                await MeetingManager.stopMeeting();
            }
        });
    }

    // Refresh status button
    const refreshBtn = document.getElementById('refresh-status');
    if (refreshBtn) {
        refreshBtn.addEventListener('click', async function() {
            refreshBtn.disabled = true;
            await StatusManager.loadEngineStatus();
            setTimeout(() => {
                refreshBtn.disabled = false;
            }, 1000);
        });
    }

    // Copy transcript button
    const copyTranscriptBtn = document.getElementById('copy-transcript');
    if (copyTranscriptBtn) {
        copyTranscriptBtn.addEventListener('click', function() {
            const text = TranscriptManager.getText();
            Utils.copyToClipboard(text).then(() => {
                NotificationManager.show('Transcript copied to clipboard', 'success');
            });
        });
    }

    // Download transcript button
    const downloadTranscriptBtn = document.getElementById('download-transcript');
    if (downloadTranscriptBtn) {
        downloadTranscriptBtn.addEventListener('click', function() {
            const text = TranscriptManager.getText();
            const timestamp = new Date().toISOString().slice(0, 10);
            Utils.downloadText(text, `transcript_${timestamp}.txt`);
            NotificationManager.show('Transcript downloaded', 'success');
        });
    }

    // Copy summary button
    const copySummaryBtn = document.getElementById('copy-summary');
    if (copySummaryBtn) {
        copySummaryBtn.addEventListener('click', function() {
            const summaryElement = document.getElementById('summary-content');
            if (summaryElement) {
                Utils.copyToClipboard(summaryElement.innerText).then(() => {
                    NotificationManager.show('Summary copied to clipboard', 'success');
                });
            }
        });
    }

    // Download summary button
    const downloadSummaryBtn = document.getElementById('download-summary');
    if (downloadSummaryBtn) {
        downloadSummaryBtn.addEventListener('click', function() {
            const summaryElement = document.getElementById('summary-content');
            if (summaryElement) {
                const timestamp = new Date().toISOString().slice(0, 10);
                Utils.downloadText(summaryElement.innerText, `summary_${timestamp}.txt`);
                NotificationManager.show('Summary downloaded', 'success');
            }
        });
    }

    // Share summary button
    const shareSummaryBtn = document.getElementById('share-summary');
    if (shareSummaryBtn) {
        shareSummaryBtn.addEventListener('click', async function() {
            const summaryElement = document.getElementById('summary-content');
            if (summaryElement && navigator.share) {
                try {
                    await navigator.share({
                        title: 'Meeting Summary',
                        text: summaryElement.innerText
                    });
                } catch (err) {
                    console.log('Share cancelled or failed:', err);
                }
            } else {
                // Fallback: copy to clipboard
                Utils.copyToClipboard(summaryElement.innerText).then(() => {
                    NotificationManager.show('Summary copied to clipboard (Share not supported)', 'info');
                });
            }
        });
    }

    // Load engine status on page load
    StatusManager.loadEngineStatus();

    // Override meeting handlers to update UI
    const originalStartHandler = MeetingManager.handleMeetingStarted;
    MeetingManager.handleMeetingStarted = function(data) {
        originalStartHandler.call(this, data);

        // Update status
        const statusDiv = document.getElementById('meeting-status');
        if (statusDiv) {
            statusDiv.innerHTML = `
                <div class="alert alert-success">
                    <div class="alert-icon">âœ“</div>
                    <div class="alert-content">
                        <strong>Recording</strong><br>
                        <small>${data.title}</small>
                    </div>
                </div>
            `;
        }

        // Show live metrics
        UIManager.showElement('live-metrics');

        // Enable transcript buttons
        document.getElementById('copy-transcript').disabled = false;
        document.getElementById('download-transcript').disabled = false;

        // Update transcript stats
        const statsElement = document.getElementById('transcript-stats');
        if (statsElement) {
            statsElement.innerHTML = 'Recording... <span class="status-indicator online"></span>';
        }
    };

    const originalStopHandler = MeetingManager.handleMeetingStopped;
    MeetingManager.handleMeetingStopped = function(data) {
        originalStopHandler.call(this, data);

        // Update status
        const statusDiv = document.getElementById('meeting-status');
        if (statusDiv) {
            statusDiv.innerHTML = `
                <div class="alert alert-info">
                    <div class="alert-icon">â„¹</div>
                    <div class="alert-content">
                        <strong>Ready to start</strong><br>
                        <small>No active meeting</small>
                    </div>
                </div>
            `;
        }

        // Hide live metrics
        UIManager.hideElement('live-metrics');

        // Update transcript stats
        const statsElement = document.getElementById('transcript-stats');
        if (statsElement) {
            statsElement.textContent = 'Meeting ended';
        }
    };
});
</script>
{% endblock %}
