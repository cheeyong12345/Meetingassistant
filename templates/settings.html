{% extends "base.html" %}

{% block title %}Settings - Meeting Assistant{% endblock %}

{% block content %}
<div class="row">
    <div class="col-md-8">
        <h2><i class="bi bi-gear"></i> Settings</h2>

        <!-- Engine Selection -->
        <div class="card mb-4">
            <div class="card-header">
                <h5><i class="bi bi-cpu"></i> Engine Configuration</h5>
            </div>
            <div class="card-body">
                <div class="row">
                    <!-- STT Engine -->
                    <div class="col-md-6">
                        <h6>Speech-to-Text Engine</h6>
                        <form id="stt-form">
                            <div class="mb-3">
                                <select class="form-select" id="stt-engine-select" name="engine">
                                    <option value="">Select STT Engine</option>
                                    {% for engine in available_engines.stt %}
                                    <option value="{{ engine }}"
                                        {% if status.stt.name == engine %}selected{% endif %}>
                                        {{ engine|title }}
                                    </option>
                                    {% endfor %}
                                </select>
                            </div>
                            <button type="submit" class="btn btn-primary">
                                <i class="bi bi-check"></i> Apply
                            </button>
                        </form>

                        <div class="mt-3">
                            <small class="text-muted">
                                Current: <strong>{{ status.stt.name or 'None' }}</strong><br>
                                Status:
                                <span class="badge {% if status.stt.initialized %}bg-success{% else %}bg-danger{% endif %}">
                                    {% if status.stt.initialized %}Ready{% else %}Not Initialized{% endif %}
                                </span>
                            </small>
                        </div>
                    </div>

                    <!-- Summarization Engine -->
                    <div class="col-md-6">
                        <h6>Summarization Engine</h6>
                        <form id="sum-form">
                            <div class="mb-3">
                                <select class="form-select" id="sum-engine-select" name="engine">
                                    <option value="">Select Summarization Engine</option>
                                    {% for engine in available_engines.summarization %}
                                    <option value="{{ engine }}"
                                        {% if status.summarization.name == engine %}selected{% endif %}>
                                        {{ engine|title }}
                                    </option>
                                    {% endfor %}
                                </select>
                            </div>
                            <button type="submit" class="btn btn-primary">
                                <i class="bi bi-check"></i> Apply
                            </button>
                        </form>

                        <div class="mt-3">
                            <small class="text-muted">
                                Current: <strong>{{ status.summarization.name or 'None' }}</strong><br>
                                Status:
                                <span class="badge {% if status.summarization.initialized %}bg-success{% else %}bg-danger{% endif %}">
                                    {% if status.summarization.initialized %}Ready{% else %}Not Initialized{% endif %}
                                </span>
                            </small>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Audio Configuration -->
        <div class="card mb-4">
            <div class="card-header">
                <h5><i class="bi bi-mic"></i> Audio Configuration</h5>
            </div>
            <div class="card-body">
                <div class="row">
                    <div class="col-md-6">
                        <h6>Input Device</h6>
                        <select class="form-select" id="audio-device-select">
                            <option value="">Auto-detect</option>
                            {% for device in status.audio_devices %}
                            <option value="{{ device.index }}">
                                {{ device.name }} ({{ device.sample_rate }}Hz)
                            </option>
                            {% endfor %}
                        </select>
                    </div>
                    <div class="col-md-6">
                        <h6>Audio Settings</h6>
                        <div class="mb-2">
                            <label class="form-label">Sample Rate</label>
                            <select class="form-select form-select-sm">
                                <option value="16000" {% if config.audio.sample_rate == 16000 %}selected{% endif %}>16 kHz</option>
                                <option value="44100" {% if config.audio.sample_rate == 44100 %}selected{% endif %}>44.1 kHz</option>
                                <option value="48000" {% if config.audio.sample_rate == 48000 %}selected{% endif %}>48 kHz</option>
                            </select>
                        </div>
                    </div>
                </div>

                <button class="btn btn-outline-secondary mt-3">
                    <i class="bi bi-mic-fill"></i> Test Microphone
                </button>
            </div>
        </div>

        <!-- Processing Settings -->
        <div class="card mb-4">
            <div class="card-header">
                <h5><i class="bi bi-sliders"></i> Processing Settings</h5>
            </div>
            <div class="card-body">
                <div class="row">
                    <div class="col-md-6">
                        <div class="form-check form-switch mb-3">
                            <input class="form-check-input" type="checkbox" id="real-time-stt"
                                {% if config.processing.real_time_stt %}checked{% endif %}>
                            <label class="form-check-label" for="real-time-stt">
                                Real-time Speech-to-Text
                            </label>
                        </div>

                        <div class="form-check form-switch mb-3">
                            <input class="form-check-input" type="checkbox" id="auto-summarize"
                                {% if config.processing.auto_summarize %}checked{% endif %}>
                            <label class="form-check-label" for="auto-summarize">
                                Auto-generate Summary
                            </label>
                        </div>

                        <div class="form-check form-switch mb-3">
                            <input class="form-check-input" type="checkbox" id="speaker-detection"
                                {% if config.processing.speaker_detection %}checked{% endif %}>
                            <label class="form-check-label" for="speaker-detection">
                                Speaker Detection
                            </label>
                        </div>
                    </div>

                    <div class="col-md-6">
                        <div class="mb-3">
                            <label class="form-label">Chunk Duration (seconds)</label>
                            <input type="number" class="form-control" value="{{ config.processing.chunk_duration }}" min="10" max="60">
                        </div>

                        <div class="mb-3">
                            <label class="form-label">Max Meeting Duration (hours)</label>
                            <input type="number" class="form-control" value="{{ config.processing.max_meeting_duration // 3600 }}" min="1" max="12">
                        </div>
                    </div>
                </div>

                <button class="btn btn-success">
                    <i class="bi bi-check"></i> Save Settings
                </button>
            </div>
        </div>
    </div>

    <!-- System Information -->
    <div class="col-md-4">
        <div class="card">
            <div class="card-header">
                <h5><i class="bi bi-info-circle"></i> System Information</h5>
            </div>
            <div class="card-body">
                <div class="mb-3">
                    <strong>Application Version:</strong><br>
                    <span class="text-muted">{{ config.app.version }}</span>
                </div>

                <div class="mb-3">
                    <strong>Audio Devices:</strong><br>
                    <span class="text-muted">{{ status.audio_devices|length }} detected</span>
                </div>

                <div class="mb-3">
                    <strong>Available STT Engines:</strong><br>
                    {% for engine in available_engines.stt %}
                    <span class="badge bg-secondary me-1">{{ engine }}</span>
                    {% endfor %}
                </div>

                <div class="mb-3">
                    <strong>Available Summarization Engines:</strong><br>
                    {% for engine in available_engines.summarization %}
                    <span class="badge bg-secondary me-1">{{ engine }}</span>
                    {% endfor %}
                </div>

                <hr>

                <div class="mb-3">
                    <strong>Data Directory:</strong><br>
                    <small class="text-muted">{{ config.storage.data_dir }}</small>
                </div>

                <div class="mb-3">
                    <strong>Models Directory:</strong><br>
                    <small class="text-muted">{{ config.storage.models_dir }}</small>
                </div>
            </div>
        </div>

        <!-- Quick Actions -->
        <div class="card mt-4">
            <div class="card-header">
                <h5><i class="bi bi-lightning"></i> Quick Actions</h5>
            </div>
            <div class="card-body">
                <button class="btn btn-outline-primary btn-sm w-100 mb-2">
                    <i class="bi bi-download"></i> Download Models
                </button>

                <button class="btn btn-outline-secondary btn-sm w-100 mb-2">
                    <i class="bi bi-folder"></i> Open Data Folder
                </button>

                <button class="btn btn-outline-info btn-sm w-100 mb-2">
                    <i class="bi bi-graph-up"></i> System Performance
                </button>

                <button class="btn btn-outline-warning btn-sm w-100">
                    <i class="bi bi-arrow-clockwise"></i> Restart Services
                </button>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block extra_js %}
<script>
    // STT Engine form submission
    document.getElementById('stt-form').addEventListener('submit', async function(e) {
        e.preventDefault();

        const formData = new FormData(e.target);
        const engine = formData.get('engine');

        if (!engine) {
            showAlert('Please select an STT engine', 'warning');
            return;
        }

        try {
            const response = await fetch('/api/engines/stt', {
                method: 'POST',
                body: formData
            });

            const result = await response.json();

            if (result.success) {
                showAlert(`Successfully switched to ${engine} STT engine`, 'success');
                setTimeout(() => location.reload(), 1500);
            } else {
                showAlert(`Failed to switch STT engine: ${result.error || 'Unknown error'}`, 'danger');
            }
        } catch (error) {
            showAlert(`Error switching STT engine: ${error.message}`, 'danger');
        }
    });

    // Summarization Engine form submission
    document.getElementById('sum-form').addEventListener('submit', async function(e) {
        e.preventDefault();

        const formData = new FormData(e.target);
        const engine = formData.get('engine');

        if (!engine) {
            showAlert('Please select a summarization engine', 'warning');
            return;
        }

        try {
            const response = await fetch('/api/engines/summarization', {
                method: 'POST',
                body: formData
            });

            const result = await response.json();

            if (result.success) {
                showAlert(`Successfully switched to ${engine} summarization engine`, 'success');
                setTimeout(() => location.reload(), 1500);
            } else {
                showAlert(`Failed to switch summarization engine: ${result.error || 'Unknown error'}`, 'danger');
            }
        } catch (error) {
            showAlert(`Error switching summarization engine: ${error.message}`, 'danger');
        }
    });

    function showAlert(message, type) {
        const alertDiv = document.createElement('div');
        alertDiv.className = `alert alert-${type} alert-dismissible fade show`;
        alertDiv.innerHTML = `
            ${message}
            <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
        `;

        // Insert at top of content
        const container = document.querySelector('.container');
        container.insertBefore(alertDiv, container.firstChild);

        // Auto-dismiss after 5 seconds
        setTimeout(() => {
            alertDiv.remove();
        }, 5000);
    }
</script>
{% endblock %}