{% extends "base.html" %}

{% block title %}Transcribe - Meeting Assistant{% endblock %}

{% block content %}
<div class="row">
    <div class="col-md-8">
        <h2><i class="bi bi-file-earmark-text"></i> Transcribe Audio</h2>

        <!-- File Upload -->
        <div class="card mb-4">
            <div class="card-header">
                <h5><i class="bi bi-upload"></i> Upload Audio File</h5>
            </div>
            <div class="card-body">
                <form id="transcribe-form" enctype="multipart/form-data">
                    <div class="mb-3">
                        <label for="audio-file" class="form-label">Audio File</label>
                        <input type="file" class="form-control" id="audio-file" name="file"
                               accept="audio/*,.wav,.mp3,.m4a,.flac,.ogg" required>
                        <div class="form-text">
                            Supported formats: WAV, MP3, M4A, FLAC, OGG
                        </div>
                    </div>

                    <button type="submit" class="btn btn-primary">
                        <i class="bi bi-play-fill"></i>
                        Start Transcription
                    </button>
                </form>
            </div>
        </div>

        <!-- Transcription Results -->
        <div id="transcription-results" class="card" style="display: none;">
            <div class="card-header">
                <h5><i class="bi bi-file-text"></i> Transcription Results</h5>
            </div>
            <div class="card-body">
                <div id="transcription-content" class="transcript-area mb-3">
                    <!-- Transcription will appear here -->
                </div>

                <div class="row">
                    <div class="col-md-6">
                        <small class="text-muted">
                            <strong>Engine:</strong> <span id="transcription-engine">-</span><br>
                            <strong>Language:</strong> <span id="transcription-language">-</span><br>
                            <strong>Confidence:</strong> <span id="transcription-confidence">-</span>
                        </small>
                    </div>
                    <div class="col-md-6 text-end">
                        <button id="copy-transcript" class="btn btn-outline-secondary btn-sm">
                            <i class="bi bi-clipboard"></i> Copy
                        </button>
                        <button id="download-transcript" class="btn btn-outline-primary btn-sm">
                            <i class="bi bi-download"></i> Download
                        </button>
                        <button id="summarize-transcript" class="btn btn-success btn-sm">
                            <i class="bi bi-list-ul"></i> Summarize
                        </button>
                    </div>
                </div>
            </div>
        </div>

        <!-- Text Summarization -->
        <div class="card mt-4">
            <div class="card-header">
                <h5><i class="bi bi-list-ul"></i> Text Summarization</h5>
            </div>
            <div class="card-body">
                <form id="summarize-form">
                    <div class="mb-3">
                        <label for="text-input" class="form-label">Text to Summarize</label>
                        <textarea class="form-control" id="text-input" name="text" rows="6"
                                  placeholder="Paste your meeting transcript or any text here..."></textarea>
                    </div>

                    <button type="submit" class="btn btn-success">
                        <i class="bi bi-cpu"></i>
                        Generate Summary
                    </button>
                </form>
            </div>
        </div>

        <!-- Summary Results -->
        <div id="summary-results" class="card mt-4" style="display: none;">
            <div class="card-header">
                <h5><i class="bi bi-file-earmark-check"></i> Summary Results</h5>
            </div>
            <div class="card-body">
                <div id="summary-content">
                    <!-- Summary will appear here -->
                </div>

                <div class="mt-3 text-end">
                    <button id="copy-summary" class="btn btn-outline-secondary btn-sm">
                        <i class="bi bi-clipboard"></i> Copy Summary
                    </button>
                    <button id="download-summary" class="btn btn-outline-primary btn-sm">
                        <i class="bi bi-download"></i> Download Summary
                    </button>
                </div>
            </div>
        </div>
    </div>

    <!-- Progress and Status -->
    <div class="col-md-4">
        <div class="card">
            <div class="card-header">
                <h5><i class="bi bi-activity"></i> Processing Status</h5>
            </div>
            <div class="card-body">
                <div id="processing-status">
                    <div class="alert alert-secondary">
                        <i class="bi bi-info-circle"></i>
                        Ready to process files
                    </div>
                </div>

                <div id="progress-container" style="display: none;">
                    <div class="progress mb-3">
                        <div id="progress-bar" class="progress-bar progress-bar-striped progress-bar-animated"
                             role="progressbar" style="width: 0%"></div>
                    </div>
                    <div id="progress-text" class="text-center">
                        <small class="text-muted">Processing...</small>
                    </div>
                </div>
            </div>
        </div>

        <!-- File Information -->
        <div id="file-info" class="card mt-4" style="display: none;">
            <div class="card-header">
                <h5><i class="bi bi-file-music"></i> File Information</h5>
            </div>
            <div class="card-body">
                <div id="file-details">
                    <!-- File details will appear here -->
                </div>
            </div>
        </div>

        <!-- Tips -->
        <div class="card mt-4">
            <div class="card-header">
                <h5><i class="bi bi-lightbulb"></i> Tips</h5>
            </div>
            <div class="card-body">
                <ul class="list-unstyled">
                    <li class="mb-2">
                        <i class="bi bi-check text-success"></i>
                        Use high-quality audio files for best results
                    </li>
                    <li class="mb-2">
                        <i class="bi bi-check text-success"></i>
                        WAV format provides the best accuracy
                    </li>
                    <li class="mb-2">
                        <i class="bi bi-check text-success"></i>
                        Reduce background noise when possible
                    </li>
                    <li class="mb-2">
                        <i class="bi bi-check text-success"></i>
                        Clear speech improves transcription quality
                    </li>
                </ul>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block extra_js %}
<script>
    let currentTranscript = '';
    let currentSummary = '';

    // File transcription form
    document.getElementById('transcribe-form').addEventListener('submit', async function(e) {
        e.preventDefault();

        const fileInput = document.getElementById('audio-file');
        const file = fileInput.files[0];

        if (!file) {
            showAlert('Please select an audio file', 'warning');
            return;
        }

        // Show file information
        showFileInfo(file);

        // Show progress
        showProgress('Uploading and transcribing...');

        const formData = new FormData();
        formData.append('file', file);

        try {
            const response = await fetch('/api/transcribe', {
                method: 'POST',
                body: formData
            });

            const result = await response.json();

            hideProgress();

            if (result.text) {
                showTranscriptionResults(result);
                currentTranscript = result.text;

                // Auto-populate summarization text area
                document.getElementById('text-input').value = result.text;
            } else {
                showAlert(`Transcription failed: ${result.error || 'Unknown error'}`, 'danger');
            }
        } catch (error) {
            hideProgress();
            showAlert(`Error during transcription: ${error.message}`, 'danger');
        }
    });

    // Text summarization form
    document.getElementById('summarize-form').addEventListener('submit', async function(e) {
        e.preventDefault();

        const text = document.getElementById('text-input').value.trim();

        if (!text) {
            showAlert('Please enter text to summarize', 'warning');
            return;
        }

        showProgress('Generating summary...');

        const formData = new FormData();
        formData.append('text', text);

        try {
            const response = await fetch('/api/summarize', {
                method: 'POST',
                body: formData
            });

            const result = await response.json();

            hideProgress();

            if (result.success) {
                showSummaryResults(result);
                currentSummary = result;
            } else {
                showAlert(`Summarization failed: ${result.error || 'Unknown error'}`, 'danger');
            }
        } catch (error) {
            hideProgress();
            showAlert(`Error during summarization: ${error.message}`, 'danger');
        }
    });

    // Copy transcript button
    document.getElementById('copy-transcript').addEventListener('click', function() {
        navigator.clipboard.writeText(currentTranscript).then(function() {
            showAlert('Transcript copied to clipboard', 'success');
        });
    });

    // Download transcript button
    document.getElementById('download-transcript').addEventListener('click', function() {
        downloadText(currentTranscript, 'transcript.txt');
    });

    // Summarize transcript button
    document.getElementById('summarize-transcript').addEventListener('click', function() {
        if (currentTranscript) {
            document.getElementById('text-input').value = currentTranscript;
            document.getElementById('text-input').scrollIntoView({ behavior: 'smooth' });
        }
    });

    // Copy summary button
    document.getElementById('copy-summary').addEventListener('click', function() {
        const summaryText = formatSummaryForCopy(currentSummary);
        navigator.clipboard.writeText(summaryText).then(function() {
            showAlert('Summary copied to clipboard', 'success');
        });
    });

    // Download summary button
    document.getElementById('download-summary').addEventListener('click', function() {
        const summaryText = formatSummaryForDownload(currentSummary);
        downloadText(summaryText, 'summary.txt');
    });

    function showFileInfo(file) {
        const fileSize = (file.size / 1024 / 1024).toFixed(2);
        const fileType = file.type || 'Unknown';

        const fileDetails = `
            <div class="mb-2"><strong>Name:</strong><br><small>${file.name}</small></div>
            <div class="mb-2"><strong>Size:</strong> ${fileSize} MB</div>
            <div class="mb-2"><strong>Type:</strong> ${fileType}</div>
        `;

        document.getElementById('file-details').innerHTML = fileDetails;
        document.getElementById('file-info').style.display = 'block';
    }

    function showProgress(text) {
        document.getElementById('progress-text').innerHTML = `<small class="text-muted">${text}</small>`;
        document.getElementById('progress-container').style.display = 'block';

        // Animate progress bar
        const progressBar = document.getElementById('progress-bar');
        progressBar.style.width = '100%';
    }

    function hideProgress() {
        document.getElementById('progress-container').style.display = 'none';
    }

    function showTranscriptionResults(result) {
        document.getElementById('transcription-content').textContent = result.text;
        document.getElementById('transcription-engine').textContent = result.engine || 'Unknown';
        document.getElementById('transcription-language').textContent = result.language || 'Unknown';
        document.getElementById('transcription-confidence').textContent =
            result.confidence ? (result.confidence * 100).toFixed(1) + '%' : 'Unknown';

        document.getElementById('transcription-results').style.display = 'block';
    }

    function showSummaryResults(result) {
        let summaryHtml = '';

        if (result.summary) {
            summaryHtml += `<div class="mb-4">
                <h6><i class="bi bi-file-text"></i> Summary</h6>
                <div class="border rounded p-3 bg-light">
                    ${result.summary}
                </div>
            </div>`;
        }

        if (result.key_points && result.key_points.length > 0) {
            summaryHtml += `<div class="mb-4">
                <h6><i class="bi bi-list-ul"></i> Key Points</h6>
                <ul class="list-group list-group-flush">`;
            result.key_points.forEach(point => {
                summaryHtml += `<li class="list-group-item">${point}</li>`;
            });
            summaryHtml += `</ul></div>`;
        }

        if (result.action_items && result.action_items.length > 0) {
            summaryHtml += `<div class="mb-4">
                <h6><i class="bi bi-check-square"></i> Action Items</h6>
                <ul class="list-group list-group-flush">`;
            result.action_items.forEach(item => {
                summaryHtml += `<li class="list-group-item">
                    <i class="bi bi-square"></i> ${item}
                </li>`;
            });
            summaryHtml += `</ul></div>`;
        }

        document.getElementById('summary-content').innerHTML = summaryHtml;
        document.getElementById('summary-results').style.display = 'block';
    }

    function formatSummaryForCopy(summary) {
        let text = '';

        if (summary.summary) {
            text += `SUMMARY:\n${summary.summary}\n\n`;
        }

        if (summary.key_points && summary.key_points.length > 0) {
            text += `KEY POINTS:\n`;
            summary.key_points.forEach(point => {
                text += `• ${point}\n`;
            });
            text += '\n';
        }

        if (summary.action_items && summary.action_items.length > 0) {
            text += `ACTION ITEMS:\n`;
            summary.action_items.forEach(item => {
                text += `☐ ${item}\n`;
            });
        }

        return text;
    }

    function formatSummaryForDownload(summary) {
        const timestamp = new Date().toISOString().slice(0, 19).replace(/:/g, '-');
        let text = `Meeting Summary - ${timestamp}\n`;
        text += '='.repeat(50) + '\n\n';

        text += formatSummaryForCopy(summary);

        return text;
    }

    function downloadText(text, filename) {
        const blob = new Blob([text], { type: 'text/plain' });
        const url = window.URL.createObjectURL(blob);
        const a = document.createElement('a');
        a.href = url;
        a.download = filename;
        a.click();
        window.URL.revokeObjectURL(url);
    }

    function showAlert(message, type) {
        const alertDiv = document.createElement('div');
        alertDiv.className = `alert alert-${type} alert-dismissible fade show`;
        alertDiv.innerHTML = `
            ${message}
            <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
        `;

        // Insert at top of content
        const container = document.querySelector('.container');
        container.insertBefore(alertDiv, container.firstChild);

        // Auto-dismiss after 5 seconds
        setTimeout(() => {
            alertDiv.remove();
        }, 5000);
    }
</script>
{% endblock %}