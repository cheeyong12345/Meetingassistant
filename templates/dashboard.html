{% extends "base.html" %}

{% block title %}Meeting Assistant{% endblock %}

{% block content %}
<div class="container" style="max-width: 1200px; margin: 0 auto;">
    <!-- Page Header -->
    <div class="mb-4" style="text-align: center;">
        <h1 style="font-size: 2rem; font-weight: 700; background: var(--primary-gradient); -webkit-background-clip: text; -webkit-text-fill-color: transparent; margin-bottom: 0.5rem;">
            Meeting Assistant
        </h1>
        <p style="color: var(--color-gray-600); font-size: var(--font-size-base);">
            Record, transcribe, and summarize your meetings
        </p>
    </div>

    <!-- Accordion Container -->
    <div class="accordion">

        <!-- 1. Meeting Control Section -->
        <div class="accordion-item" data-section="control">
            <button class="accordion-header" data-target="control">
                <div class="accordion-title">
                    <svg width="24" height="24" viewBox="0 0 20 20" fill="currentColor">
                        <path fill-rule="evenodd" d="M10 18a8 8 0 100-16 8 8 0 000 16zM9.555 7.168A1 1 0 008 8v4a1 1 0 001.555.832l3-2a1 1 0 000-1.664l-3-2z" clip-rule="evenodd"/>
                    </svg>
                    <span>Meeting Control</span>
                </div>
                <svg class="accordion-icon" width="20" height="20" viewBox="0 0 20 20" fill="currentColor">
                    <path fill-rule="evenodd" d="M5.293 7.293a1 1 0 011.414 0L10 10.586l3.293-3.293a1 1 0 111.414 1.414l-4 4a1 1 0 01-1.414 0l-4-4a1 1 0 010-1.414z" clip-rule="evenodd"/>
                </svg>
            </button>
            <div class="accordion-content active">
                <div class="accordion-body">
                    <!-- Meeting Status -->
                    <div id="meeting-status" class="mb-3">
                        <div class="alert alert-info">
                            <div class="alert-icon">ℹ</div>
                            <div class="alert-content">No active meeting</div>
                        </div>
                    </div>

                    <!-- Recording Indicator -->
                    <div id="recording-indicator" class="recording-indicator hidden mb-3" style="display: none;">
                        <div class="recording-indicator-dot"></div>
                        <span>Recording</span>
                    </div>

                    <!-- Waveform Visualizer -->
                    <div id="waveform-container" class="waveform-container hidden" style="display: none; margin-bottom: 1.5rem;"></div>

                    <!-- Real-time Metrics -->
                    <div class="metrics-grid mb-3">
                        <div class="metric-card">
                            <div class="metric-icon">
                                <svg width="24" height="24" viewBox="0 0 20 20" fill="currentColor">
                                    <path fill-rule="evenodd" d="M10 18a8 8 0 100-16 8 8 0 000 16zm1-12a1 1 0 10-2 0v4a1 1 0 00.293.707l2.828 2.829a1 1 0 101.415-1.415L11 9.586V6z" clip-rule="evenodd"/>
                                </svg>
                            </div>
                            <div class="metric-label">Duration</div>
                            <div class="metric-value" id="meeting-duration">00:00</div>
                        </div>

                        <div class="metric-card">
                            <div class="metric-icon">
                                <svg width="24" height="24" viewBox="0 0 20 20" fill="currentColor">
                                    <path fill-rule="evenodd" d="M18 10c0 3.866-3.582 7-8 7a8.841 8.841 0 01-4.083-.98L2 17l1.338-3.123C2.493 12.767 2 11.434 2 10c0-3.866 3.582-7 8-7s8 3.134 8 7zM7 9H5v2h2V9zm8 0h-2v2h2V9zM9 9h2v2H9V9z" clip-rule="evenodd"/>
                                </svg>
                            </div>
                            <div class="metric-label">Words</div>
                            <div class="metric-value" id="word-count">0</div>
                        </div>
                    </div>

                    <!-- Start Meeting Form -->
                    <div id="start-meeting-form">
                        <form id="meeting-form">
                            <div class="form-group">
                                <label for="meeting-title" class="form-label">Meeting Title</label>
                                <input type="text" class="form-input" id="meeting-title"
                                       placeholder="Team Standup" autocomplete="off">
                                <span class="form-help">Give your meeting a descriptive title</span>
                            </div>

                            <div class="form-group">
                                <label for="participants" class="form-label">Participants</label>
                                <input type="text" class="form-input" id="participants"
                                       placeholder="John, Sarah, Mike" autocomplete="off">
                                <span class="form-help">Comma-separated list</span>
                            </div>

                            <button type="submit" class="btn btn-secondary btn-lg btn-block">
                                <svg width="20" height="20" viewBox="0 0 20 20" fill="currentColor">
                                    <path fill-rule="evenodd" d="M10 18a8 8 0 100-16 8 8 0 000 16zM9.555 7.168A1 1 0 008 8v4a1 1 0 001.555.832l3-2a1 1 0 000-1.664l-3-2z" clip-rule="evenodd"/>
                                </svg>
                                Start Meeting
                            </button>
                        </form>
                    </div>

                    <!-- Stop Meeting Button -->
                    <div id="stop-meeting-form" class="hidden" style="display: none;">
                        <button id="stop-meeting-btn" class="btn btn-danger btn-lg btn-block">
                            <svg width="20" height="20" viewBox="0 0 20 20" fill="currentColor">
                                <path fill-rule="evenodd" d="M10 18a8 8 0 100-16 8 8 0 000 16zM8 7a1 1 0 00-1 1v4a1 1 0 001 1h4a1 1 0 001-1V8a1 1 0 00-1-1H8z" clip-rule="evenodd"/>
                            </svg>
                            Stop Meeting
                        </button>
                    </div>
                </div>
            </div>
        </div>

        <!-- 2. Live Transcript Section -->
        <div class="accordion-item" data-section="transcript">
            <button class="accordion-header" data-target="transcript">
                <div class="accordion-title">
                    <svg width="24" height="24" viewBox="0 0 20 20" fill="currentColor">
                        <path fill-rule="evenodd" d="M4 4a2 2 0 012-2h4.586A2 2 0 0112 2.586L15.414 6A2 2 0 0116 7.414V16a2 2 0 01-2 2H6a2 2 0 01-2-2V4zm2 6a1 1 0 011-1h6a1 1 0 110 2H7a1 1 0 01-1-1zm1 3a1 1 0 100 2h6a1 1 0 100-2H7z" clip-rule="evenodd"/>
                    </svg>
                    <span>Live Transcript</span>
                </div>
                <svg class="accordion-icon" width="20" height="20" viewBox="0 0 20 20" fill="currentColor">
                    <path fill-rule="evenodd" d="M5.293 7.293a1 1 0 011.414 0L10 10.586l3.293-3.293a1 1 0 111.414 1.414l-4 4a1 1 0 01-1.414 0l-4-4a1 1 0 010-1.414z" clip-rule="evenodd"/>
                </svg>
            </button>
            <div class="accordion-content">
                <div class="accordion-body">
                    <div class="flex justify-between items-center mb-3" style="display: flex; align-items: center; justify-content: space-between;">
                        <div class="form-switch">
                            <input type="checkbox" id="auto-scroll" checked>
                            <label for="auto-scroll">Auto-scroll</label>
                        </div>
                        <div>
                            <button id="copy-transcript" class="btn btn-ghost btn-sm" title="Copy transcript">
                                <svg width="16" height="16" viewBox="0 0 20 20" fill="currentColor">
                                    <path d="M8 3a1 1 0 011-1h2a1 1 0 110 2H9a1 1 0 01-1-1z"/>
                                    <path d="M6 3a2 2 0 00-2 2v11a2 2 0 002 2h8a2 2 0 002-2V5a2 2 0 00-2-2 3 3 0 01-3 3H9a3 3 0 01-3-3z"/>
                                </svg>
                                Copy
                            </button>
                            <button id="download-transcript" class="btn btn-ghost btn-sm" title="Download transcript">
                                <svg width="16" height="16" viewBox="0 0 20 20" fill="currentColor">
                                    <path fill-rule="evenodd" d="M3 17a1 1 0 011-1h12a1 1 0 110 2H4a1 1 0 01-1-1zm3.293-7.707a1 1 0 011.414 0L9 10.586V3a1 1 0 112 0v7.586l1.293-1.293a1 1 0 111.414 1.414l-3 3a1 1 0 01-1.414 0l-3-3a1 1 0 010-1.414z" clip-rule="evenodd"/>
                                </svg>
                                Download
                            </button>
                        </div>
                    </div>

                    <div id="transcript" class="transcript-container">
                        <div class="transcript-empty">
                            <div class="transcript-empty-icon">🎤</div>
                            <div>Start a meeting to see the live transcript here...</div>
                        </div>
                    </div>

                    <div class="mt-3" style="font-size: var(--font-size-sm); color: var(--color-gray-600);">
                        <span id="transcript-status">Ready</span>
                    </div>
                </div>
            </div>
        </div>

        <!-- 3. Meeting Summary Section -->
        <div class="accordion-item" data-section="summary">
            <button class="accordion-header" data-target="summary">
                <div class="accordion-title">
                    <svg width="24" height="24" viewBox="0 0 20 20" fill="currentColor">
                        <path d="M9 2a1 1 0 000 2h2a1 1 0 100-2H9z"/>
                        <path fill-rule="evenodd" d="M4 5a2 2 0 012-2 3 3 0 003 3h2a3 3 0 003-3 2 2 0 012 2v11a2 2 0 01-2 2H6a2 2 0 01-2-2V5zm3 4a1 1 0 000 2h.01a1 1 0 100-2H7zm3 0a1 1 0 000 2h3a1 1 0 100-2h-3zm-3 4a1 1 0 100 2h.01a1 1 0 100-2H7zm3 0a1 1 0 100 2h3a1 1 0 100-2h-3z" clip-rule="evenodd"/>
                    </svg>
                    <span>Meeting Summary</span>
                </div>
                <svg class="accordion-icon" width="20" height="20" viewBox="0 0 20 20" fill="currentColor">
                    <path fill-rule="evenodd" d="M5.293 7.293a1 1 0 011.414 0L10 10.586l3.293-3.293a1 1 0 111.414 1.414l-4 4a1 1 0 01-1.414 0l-4-4a1 1 0 010-1.414z" clip-rule="evenodd"/>
                </svg>
            </button>
            <div class="accordion-content">
                <div class="accordion-body">
                    <div id="summary-content">
                        <div class="transcript-empty">
                            <div class="transcript-empty-icon">📝</div>
                            <div>Summary will appear here after the meeting ends...</div>
                        </div>
                    </div>
                    <button id="generate-summary" class="btn btn-secondary btn-block mt-3" style="display: none;">
                        <svg width="20" height="20" viewBox="0 0 20 20" fill="currentColor">
                            <path fill-rule="evenodd" d="M11.3 1.046A1 1 0 0112 2v5h4a1 1 0 01.82 1.573l-7 10A1 1 0 018 18v-5H4a1 1 0 01-.82-1.573l7-10a1 1 0 011.12-.38z" clip-rule="evenodd"/>
                        </svg>
                        Generate Summary
                    </button>
                </div>
            </div>
        </div>

        <!-- 4. Settings Section -->
        <div class="accordion-item" data-section="settings">
            <button class="accordion-header" data-target="settings">
                <div class="accordion-title">
                    <svg width="24" height="24" viewBox="0 0 20 20" fill="currentColor">
                        <path fill-rule="evenodd" d="M11.49 3.17c-.38-1.56-2.6-1.56-2.98 0a1.532 1.532 0 01-2.286.948c-1.372-.836-2.942.734-2.106 2.106.54.886.061 2.042-.947 2.287-1.561.379-1.561 2.6 0 2.978a1.532 1.532 0 01.947 2.287c-.836 1.372.734 2.942 2.106 2.106a1.532 1.532 0 012.287.947c.379 1.561 2.6 1.561 2.978 0a1.533 1.533 0 012.287-.947c1.372.836 2.942-.734 2.106-2.106a1.533 1.533 0 01.947-2.287c1.561-.379 1.561-2.6 0-2.978a1.532 1.532 0 01-.947-2.287c.836-1.372-.734-2.942-2.106-2.106a1.532 1.532 0 01-2.287-.947zM10 13a3 3 0 100-6 3 3 0 000 6z" clip-rule="evenodd"/>
                    </svg>
                    <span>Audio Device & Engine Settings</span>
                </div>
                <svg class="accordion-icon" width="20" height="20" viewBox="0 0 20 20" fill="currentColor">
                    <path fill-rule="evenodd" d="M5.293 7.293a1 1 0 011.414 0L10 10.586l3.293-3.293a1 1 0 111.414 1.414l-4 4a1 1 0 01-1.414 0l-4-4a1 1 0 010-1.414z" clip-rule="evenodd"/>
                </svg>
            </button>
            <div class="accordion-content">
                <div class="accordion-body">
                    <!-- Audio Device Selection -->
                    <div class="mb-3">
                        <label for="audio-device" class="form-label">
                            <svg width="16" height="16" viewBox="0 0 20 20" fill="currentColor" style="display: inline; margin-right: 0.25rem;">
                                <path d="M7 4a3 3 0 016 0v6a3 3 0 11-6 0V4z"/>
                                <path d="M5.5 9.643a.75.75 0 00-1.5 0V10c0 3.06 2.29 5.585 5.25 5.954V17.5h-1.5a.75.75 0 000 1.5h4.5a.75.75 0 000-1.5h-1.5v-1.546A6.001 6.001 0 0016 10v-.357a.75.75 0 00-1.5 0V10a4.5 4.5 0 01-9 0v-.357z"/>
                            </svg>
                            Audio Input Device
                        </label>
                        <select id="audio-device" class="form-input">
                            <option value="">Loading devices...</option>
                        </select>
                        <span class="form-help">Select microphone for recording</span>
                    </div>

                    <!-- Current Audio Device Display -->
                    <div class="mb-3">
                        <div class="alert alert-info" style="padding: 0.75rem;">
                            <div class="alert-icon" style="font-size: 1.25rem;">🎤</div>
                            <div class="alert-content" style="font-size: var(--font-size-sm);">
                                <strong>Current Device:</strong><br>
                                <span id="current-audio-device">Not selected</span>
                            </div>
                        </div>
                    </div>

                    <!-- Engine Status -->
                    <div class="mb-3">
                        <strong style="font-size: var(--font-size-sm); color: var(--color-gray-600); display: block; margin-bottom: 0.5rem;">Speech-to-Text Engine:</strong>
                        <span id="stt-engine" class="badge badge-secondary">Not initialized</span>
                    </div>
                    <div class="mb-3">
                        <strong style="font-size: var(--font-size-sm); color: var(--color-gray-600); display: block; margin-bottom: 0.5rem;">Summarization Engine:</strong>
                        <span id="sum-engine" class="badge badge-secondary">Not initialized</span>
                    </div>

                    <button id="refresh-status" class="btn btn-outline btn-block">
                        <svg width="16" height="16" viewBox="0 0 20 20" fill="currentColor">
                            <path fill-rule="evenodd" d="M4 2a1 1 0 011 1v2.101a7.002 7.002 0 0111.601 2.566 1 1 0 11-1.885.666A5.002 5.002 0 005.999 7H9a1 1 0 010 2H4a1 1 0 01-1-1V3a1 1 0 011-1zm.008 9.057a1 1 0 011.276.61A5.002 5.002 0 0014.001 13H11a1 1 0 110-2h5a1 1 0 011 1v5a1 1 0 11-2 0v-2.101a7.002 7.002 0 01-11.601-2.566 1 1 0 01.61-1.276z" clip-rule="evenodd"/>
                        </svg>
                        Refresh Status & Devices
                    </button>
                </div>
            </div>
        </div>

    </div>
</div>
{% endblock %}

{% block extra_js %}
<script>
// Accordion functionality
document.addEventListener('DOMContentLoaded', function() {
    const accordionHeaders = document.querySelectorAll('.accordion-header');

    accordionHeaders.forEach(header => {
        header.addEventListener('click', function() {
            const target = this.getAttribute('data-target');
            const content = this.nextElementSibling;
            const item = this.parentElement;

            // Toggle active class
            content.classList.toggle('active');
            item.classList.toggle('active');
        });
    });

    // Meeting form submission
    const meetingForm = document.getElementById('meeting-form');
    if (meetingForm) {
        meetingForm.addEventListener('submit', async function(e) {
            e.preventDefault();
            const title = document.getElementById('meeting-title').value.trim();
            const participants = document.getElementById('participants').value.trim();
            await MeetingManager.startMeeting(title, participants);

            // Auto-open transcript section
            const transcriptSection = document.querySelector('[data-section="transcript"]');
            const transcriptContent = transcriptSection.querySelector('.accordion-content');
            transcriptContent.classList.add('active');
            transcriptSection.classList.add('active');
        });
    }

    // Stop meeting button
    const stopBtn = document.getElementById('stop-meeting-btn');
    if (stopBtn) {
        stopBtn.addEventListener('click', async function() {
            if (confirm('Are you sure you want to stop the meeting?')) {
                await MeetingManager.stopMeeting();

                // Auto-open summary section
                const summarySection = document.querySelector('[data-section="summary"]');
                const summaryContent = summarySection.querySelector('.accordion-content');
                summaryContent.classList.add('active');
                summarySection.classList.add('active');
            }
        });
    }

    // Load audio devices
    async function loadAudioDevices() {
        try {
            const response = await fetch('/api/audio-devices');
            const data = await response.json();

            const select = document.getElementById('audio-device');
            const currentDisplay = document.getElementById('current-audio-device');

            if (data.devices && data.devices.length > 0) {
                select.innerHTML = '<option value="">Default Device</option>';
                data.devices.forEach(device => {
                    const option = document.createElement('option');
                    option.value = device.index;
                    option.textContent = `${device.name} (${device.channels} channels, ${device.sample_rate}Hz)`;
                    select.appendChild(option);
                });

                // Set current device
                if (data.current_device) {
                    currentDisplay.textContent = data.current_device;
                } else {
                    currentDisplay.textContent = 'Default System Device';
                }
            } else {
                select.innerHTML = '<option value="">No devices found</option>';
                currentDisplay.textContent = 'No audio input detected';
            }
        } catch (error) {
            console.error('Failed to load audio devices:', error);
            NotificationManager.show('Failed to load audio devices', 'danger');
        }
    }

    // Audio device selection change
    const audioDeviceSelect = document.getElementById('audio-device');
    if (audioDeviceSelect) {
        audioDeviceSelect.addEventListener('change', async function() {
            const deviceIndex = this.value;
            try {
                const response = await fetch('/api/set-audio-device', {
                    method: 'POST',
                    headers: {'Content-Type': 'application/json'},
                    body: JSON.stringify({device_index: deviceIndex || null})
                });

                const data = await response.json();
                if (data.success) {
                    document.getElementById('current-audio-device').textContent =
                        this.options[this.selectedIndex].text || 'Default System Device';
                    NotificationManager.show('Audio device updated', 'success');
                } else {
                    NotificationManager.show('Failed to set audio device', 'danger');
                }
            } catch (error) {
                NotificationManager.show('Failed to set audio device', 'danger');
            }
        });
    }

    // Refresh status button
    const refreshBtn = document.getElementById('refresh-status');
    if (refreshBtn) {
        refreshBtn.addEventListener('click', function() {
            StatusManager.loadEngineStatus();
            loadAudioDevices();
            NotificationManager.show('Status refreshed', 'info', 2000);
        });
    }

    // Load audio devices on page load
    loadAudioDevices();

    // Auto-scroll toggle
    const autoScrollToggle = document.getElementById('auto-scroll');
    if (autoScrollToggle) {
        autoScrollToggle.addEventListener('change', function() {
            AppState.settings.autoScroll = this.checked;
            StorageManager.save('settings', AppState.settings);
        });
    }

    // Copy transcript button
    const copyBtn = document.getElementById('copy-transcript');
    if (copyBtn) {
        copyBtn.addEventListener('click', async function() {
            const text = TranscriptManager.getText();
            if (text) {
                try {
                    await Utils.copyToClipboard(text);
                    NotificationManager.show('Transcript copied to clipboard', 'success');
                } catch (error) {
                    NotificationManager.show('Failed to copy transcript', 'danger');
                }
            } else {
                NotificationManager.show('No transcript to copy', 'warning');
            }
        });
    }

    // Download transcript button
    const downloadBtn = document.getElementById('download-transcript');
    if (downloadBtn) {
        downloadBtn.addEventListener('click', function() {
            const text = TranscriptManager.getText();
            if (text) {
                const timestamp = new Date().toISOString().slice(0, 19).replace(/:/g, '-');
                Utils.downloadText(text, `transcript-${timestamp}.txt`);
                NotificationManager.show('Transcript downloaded', 'success');
            } else {
                NotificationManager.show('No transcript to download', 'warning');
            }
        });
    }

    // Generate summary button
    const generateSummaryBtn = document.getElementById('generate-summary');
    if (generateSummaryBtn) {
        generateSummaryBtn.addEventListener('click', async function() {
            const text = TranscriptManager.getText();
            if (text) {
                this.disabled = true;
                this.innerHTML = '<span class="spinner"></span> Generating...';

                try {
                    const response = await fetch('/api/summarize', {
                        method: 'POST',
                        headers: {'Content-Type': 'application/json'},
                        body: JSON.stringify({text: text})
                    });

                    const data = await response.json();
                    if (data.summary) {
                        document.getElementById('summary-content').innerHTML = `<div class="summary-text">${data.summary}</div>`;
                        NotificationManager.show('Summary generated', 'success');
                    }
                } catch (error) {
                    NotificationManager.show('Failed to generate summary', 'danger');
                } finally {
                    this.disabled = false;
                    this.innerHTML = '<svg width="20" height="20" viewBox="0 0 20 20" fill="currentColor"><path fill-rule="evenodd" d="M11.3 1.046A1 1 0 0112 2v5h4a1 1 0 01.82 1.573l-7 10A1 1 0 018 18v-5H4a1 1 0 01-.82-1.573l7-10a1 1 0 011.12-.38z" clip-rule="evenodd"/></svg> Generate Summary';
                }
            }
        });
    }
});
</script>
{% endblock %}
